<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="admin.css">
    <link rel="stylesheet" href="add_product.css">
    <link rel="stylesheet" href="list_product.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Admin Dashboard</h3>
        </div>
        <div class="sidebar-menu">
            <ul>
                <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                
                <li class="has-dropdown">
                    <a href="#"><i class="fas fa-shopping-cart"></i> <span>Quản lý đơn hàng</span> <i class="fas fa-chevron-right dropdown-icon"></i></a>
                    <ul class="submenu">
                        <li><a href="#"><i class="fas fa-list"></i> Danh sách đơn hàng</a></li>
                        <li><a href="#"><i class="fa-solid fa-circle-check"></i> Xác nhận đơn hàng</a></li>
                        <li><a href="#"><i class="fas fa-edit"></i> Cập nhật đơn hàng</a></li>
                        <li><a href="#"><i class="fas fa-trash-alt"></i> Xóa/Hủy đơn hàng</a></li>
                    </ul>
                </li>
                
                <li class="has-dropdown">
                    <a href="#"><i class="fas fa-box-open"></i> <span>Quản lý sản phẩm</span> <i class="fas fa-chevron-right dropdown-icon"></i></a>
                    <ul class="submenu">
                        <li><a href="#" id="list-product-link"><i class="fas fa-list"></i> Danh sách sản phẩm</a></li>
                        <li><a href="#" id="add-product-link"><i class="fas fa-plus-circle"></i> Thêm sản phẩm</a></li>
                        <li><a href="#" id="category-product-link"><i class="fas fa-tags"></i> Danh mục sản phẩm</a></li>
                    </ul>
                </li>

                <li class="has-dropdown">
                    <a href="#"><i class="fas fa-users"></i> <span>Quản lý khách hàng</span> <i class="fas fa-chevron-right dropdown-icon"></i></a>
                    <ul class="submenu">
                        <li><a href="#"><i class="fas fa-list"></i> Danh sách khách hàng</a></li>
                        <li><a href="#"><i class="fa-solid fa-magnifying-glass"></i> Tìm thông tin</a></li>
                        <li><a href="#"><i class="fa-solid fa-user-lock"></i> Khóa/Mở tài khoản</a></li>
                    </ul>
                </li>

                <li class="has-dropdown">
                    <a href="#"><i class="fas fa-chart-line"></i> <span>Thống kê</span> <i class="fas fa-chevron-right dropdown-icon"></i></a>
                    <ul class="submenu">
                        <li><a href="#"><i class="fa-solid fa-square-poll-vertical"></i> Thống kê doanh thu</a></li>
                        <li><a href="#"><i class="fas fa-shopping-cart"></i> Thống kê đơn hàng</a></li>
                        <li><a href="#"><i class="fas fa-box-open"></i> Sản phẩm bán chạy</a></li>
                        <li><a href="#"><i class="fas fa-users"></i> Khách hàng thân quen</a></li>
                    </ul>
                </li>

                <li class="has-dropdown">
                    <a href="#"><i class="fas fa-cog"></i> <span>Cài đặt</span> <i class="fas fa-chevron-right dropdown-icon"></i></a>
                    <ul class="submenu">
                        <li><a href="#"><i class="fas fa-edit"></i> Chỉnh sửa hồ sơ</a></li>
                        <li><a href="../HTML/home.html" onclick="handleLogout(event)"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h2>Dashboard</h2>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="dashboard-content">
            <!-- Cards -->
            <div class="cards">
                <div class="card">
                    <div class="card-header">
                        <h3>Tổng đơn hàng</h3>
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="card-body">
                        <div class="card-value">1,245</div>
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Tổng sản phẩm</h3>
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="card-body">
                        <div class="card-value" id="total-products">0</div>
                        <div class="card-icon">
                            <i class="fas fa-warehouse"></i>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Tổng khách hàng</h3>
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-body">
                        <div class="card-value">0</div>
                        <div class="card-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Tổng doanh thu</h3>
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="card-body">
                        <div class="card-value">$45,678</div>
                        <div class="card-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="content-section">
                <div class="section-header">
                    <h3>Đơn hàng gần đây</h3>
                    <button class="btn">Xem tất cả</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Ngày đặt</th>
                            <th>Tổng tiền</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Add Product Form -->
        <div id="add-product-content" style="display: none;">
            <div class="product-form-container">
                <form id="productForm">
                    <!-- Thông tin cơ bản -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Thông tin cơ bản</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="productName">Tên sản phẩm *</label>
                                <input type="text" id="productName" name="productName" placeholder="Nhập tên sản phẩm" required>
                            </div>
                            <div class="form-group">
                                <label for="brand">Thương hiệu</label>
                                <input type="text" id="brand" name="brand" placeholder="Nhập thương hiệu">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="category">Danh mục</label>
                                <select id="category" name="category">
                                    <option value="">Chọn danh mục</option>
                                    <option value="1">Giày nam</option>
                                    <option value="2">Giày nữ</option>
                                    <option value="3">Giày da</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="price">Giá bán (VND) *</label>
                                <input type="number" id="price" name="price" min="0" step="1000" placeholder="0" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">Mô tả sản phẩm</label>
                            <textarea id="productDescription" name="productDescription" placeholder="Nhập mô tả chi tiết về sản phẩm"></textarea>
                        </div>
                    </div>

                    <!-- Hình ảnh sản phẩm -->
                    <div class="form-section">
                        <h3><i class="fas fa-images"></i> Hình ảnh sản phẩm</h3>
                        <div class="image-upload-container">
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Kéo thả hình ảnh vào đây hoặc click để chọn</p>
                                <input type="file" id="imageUpload" multiple accept="image/*" style="display: none;">
                            </div>
                            <div class="image-preview" id="imagePreview"></div>
                        </div>
                    </div>

                    <!-- Quản lý kho -->
                    <div class="form-section">
                        <h3><i class="fas fa-boxes"></i> Quản lý kho</h3>
                        <button type="button" class="btn btn-add" id="addVariantBtn">
                            <i class="fas fa-plus"></i> Thêm biến thể
                        </button>
                        
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th>Màu sắc</th>
                                    <th>Kích thước</th>
                                    <th>Số lượng</th>
                                    <th>Xóa</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody">
                                <!-- Các dòng biến thể sẽ được thêm vào đây -->
                            </tbody>
                        </table>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel">Hủy bỏ</button>
                        <button type="submit" class="btn btn-submit">
                            <i class="fas fa-save"></i> Lưu sản phẩm
                        </button>
                    </div>
                </form>
            </div>

            <!-- Template cho dòng biến thể -->
            <template id="variantTemplate">
                <tr>
                    <td>
                        <input type="text" class="color-input" required>
                    </td>
                    <td>
                        <input type="text" class="size-input" required>
                    </td>
                    <td>
                        <input type="number" class="quantity-input" min="0" value="0" required>
                    </td>
                    <td>
                        <button type="button" class="btn btn-remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            </template>
        </div>

        <!-- Danh sách sản phẩm -->
        <div class="product-list-container" id="list-product-content" style="display: none;">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> Danh sách sản phẩm</h3>
                <div class="action-buttons">
                    <button class="btn btn-add" id="refreshProductList">
                        <i class="fas fa-sync-alt"></i> Làm mới
                    </button>
                </div>
            </div>
            
            <div class="search-filter">
                <input type="text" id="searchKeyword" placeholder="Tìm kiếm sản phẩm..." class="search-input">
                <select class="category-filter" id="searchCategory">
                    <option value="">Tất cả danh mục</option>
                    <option value="1">Giày nam</option>
                    <option value="2">Giày nữ</option>
                    <option value="3">Giày thể thao</option>
                </select>
                <button class="btn btn-filter" id="searchButton">
                    <i class="fas fa-filter"></i> Lọc
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Hình ảnh</th>
                            <th>Tên sản phẩm</th>
                            <th>Thương hiệu</th>
                            <th>Giá</th>
                            <th>Tồn kho</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="pagination">
                <button class="btn btn-prev" id="prevPage"><i class="fas fa-chevron-left"></i></button>
                <span class="page-numbers" id="pageInfo">1/1</span>
                <button class="btn btn-next" id="nextPage"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 0;
        const pageSize = 8;
        let totalPages = 1;
        
        // DOM elements
        const listProductLink = document.getElementById('list-product-link');
        const addProductLink = document.getElementById('add-product-link');
        const dashboardContent = document.getElementById('dashboard-content');
        const addProductContent = document.getElementById('add-product-content');
        const listProductContent = document.getElementById('list-product-content');
        const productForm = document.getElementById('productForm');
        const searchButton = document.getElementById('searchButton');
        const refreshProductList = document.getElementById('refreshProductList');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const searchKeyword = document.getElementById('searchKeyword');
        const searchCategory = document.getElementById('searchCategory');
        const productTableBody = document.getElementById('productTableBody');
        const totalProductsElement = document.getElementById('total-products');
    
        // Navigation handlers
        document.getElementById('list-product-link').addEventListener('click', function(e) {
            e.preventDefault();
            showProductList();
            loadProducts();
        });
    
        document.getElementById('add-product-link').addEventListener('click', function(e) {
            e.preventDefault();
            showAddProductForm();
        });
    
        // Show/hide sections
        function showDashboard() {
            dashboardContent.style.display = 'block';
            addProductContent.style.display = 'none';
            listProductContent.style.display = 'none';
        }
    
        function showAddProductForm() {
            dashboardContent.style.display = 'none';
            addProductContent.style.display = 'block';
            listProductContent.style.display = 'none';
        }
    
        function showProductList() {
            dashboardContent.style.display = 'none';
            addProductContent.style.display = 'none';
            listProductContent.style.display = 'block';
        }
    
        // Product form submission
        productForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                brand: document.getElementById('brand').value,
                categoryId: document.getElementById('category').value,
                price: document.getElementById('price').value,
                description: document.getElementById('productDescription').value,
                // Add variants and images here
            };
            
            const token = localStorage.getItem("authToken");
            
            fetch('http://localhost:8080/products/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                alert('Sản phẩm đã được thêm thành công!');
                productForm.reset();
                showProductList();
                loadProducts();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi thêm sản phẩm');
            });
        });
    
        // Load products with pagination
        function loadProducts() {
            const keyword = searchKeyword.value;
            const category = searchCategory.value;
            const token = localStorage.getItem("authToken");
            
            // Build query parameters
            let params = new URLSearchParams();
            params.append('page', currentPage);
            console.log(currentPage);
            params.append('size', pageSize);
            console.log(pageSize);

            if (keyword) params.append('keyword', keyword);
            if (category) params.append('category', category);
            const url =`http://localhost:8080/products/search?${params.toString()}`;
            fetch(`http://localhost:8080/products/search?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update total products count
                totalProductsElement.textContent = data.totalElements || 0;
                const ccc = data.content;

                // Update pagination info
                totalPages = data.totalPages || 1;
                document.getElementById('pageInfo').textContent = `${currentPage + 1}/${totalPages}`;
                
                // Clear table
                productTableBody.innerHTML = '';
                
                // Add products to table
                if (data.content && data.content.length > 0) {
    data.content.forEach(product => {
        const stockQuantity = product.sizeColorList?.reduce((total, item) => total + (item.quantity || 0), 0) || 0;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${product.productId}</td>
            <td><img src="${product.imageUrl || 'https://via.placeholder.com/50'}" alt="${product.productName}" class="product-thumbnail"></td>
            <td>${product.productName}</td>
            <td>${product.brand || 'N/A'}</td>
            <td>${product.price ? product.price.toLocaleString() + 'đ' : 'N/A'}</td>
            <td>${stockQuantity}</td>
            <td><span class="status ${product.status === 'ACTIVE' ? 'status-active' : 'status-inactive'}">
                ${product.status === 'ACTIVE' ? 'Đang bán' : 'Ngừng bán'}</span>
            </td>
            <td>
                <button class="btn btn-edit" onclick="editProduct(${product.productId})"><i class="fas fa-edit"></i></button>
                <button class="btn btn-delete" onclick="deleteProduct(${product.productId})"><i class="fas fa-trash-alt"></i></button>
            </td>
        `;
        productTableBody.appendChild(row);
    });


                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="8" class="text-center">Không có sản phẩm nào</td>';
                    productTableBody.appendChild(row);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                productTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Lỗi khi tải dữ liệu</td></tr>';
            });
        }
    
        // Get all products (without pagination)
        function getAllProducts() {
            const token = localStorage.getItem("authToken");
            
            fetch('http://localhost:8080/products', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(products => {
                // Process the list of all products here
                console.log('All products:', products);
                // You can use this for exports or other operations that need all products
            })
            .catch(error => {
                console.error('Error fetching all products:', error);
            });
        }
    
        // Edit product
        function editProduct(productId) {
            // First fetch the product details
            const token = localStorage.getItem("authToken");
            
            fetch(`http://localhost:8080/products/${productId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(product => {
                // Populate the form with product data
                document.getElementById('productName').value = product.name;
                document.getElementById('brand').value = product.brand;
                document.getElementById('category').value = product.categoryId;
                document.getElementById('price').value = product.price;
                document.getElementById('productDescription').value = product.description;
                
                // Show the edit form
                showAddProductForm();
                
                // Change form to update mode
                productForm.onsubmit = function(e) {
                    e.preventDefault();
                    
                    const updatedProduct = {
                        name: document.getElementById('productName').value,
                        brand: document.getElementById('brand').value,
                        categoryId: document.getElementById('category').value,
                        price: document.getElementById('price').value,
                        description: document.getElementById('productDescription').value
                    };
                    
                    fetch(`http://localhost:8080/products/edit/${productId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updatedProduct)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert('Sản phẩm đã được cập nhật thành công!');
                        showProductList();
                        loadProducts();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi cập nhật sản phẩm');
                    });
                };
            })
            .catch(error => {
                console.error('Error fetching product details:', error);
                alert('Không thể tải thông tin sản phẩm');
            });
        }
    
        // Delete product
        function deleteProduct(productId) {
            if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
                const token = localStorage.getItem("authToken");
                
                fetch(`http://localhost:8080/products/delete/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Sản phẩm đã được xóa thành công!');
                        loadProducts();
                    } else {
                        alert('Có lỗi xảy ra khi xóa sản phẩm');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa sản phẩm');
                });
            }
        }
    
        // Pagination handlers
        prevPage.addEventListener('click', function() {
            if (currentPage > 0) {
                currentPage--;
                loadProducts();
            }
        });
    
        nextPage.addEventListener('click', function() {
            if (currentPage < totalPages - 1) {
                currentPage++;
                loadProducts();
            }
        });
    
        // Search handler
        searchButton.addEventListener('click', function() {
            currentPage = 0;
            loadProducts();
        });
    
        // Refresh handler
        refreshProductList.addEventListener('click', function() {
            currentPage = 0;
            searchKeyword.value = '';
            searchCategory.value = '';
            loadProducts();
        });
    
        // Logout handler
        async function handleLogout(event) {
            event.preventDefault();
            const token = localStorage.getItem("authToken");
            try {
                const response = await fetch('http://localhost:8080/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        "Authorization": `Bearer ${token}`
                    }
                }).then(res => {
                    if (res.ok) {
                        alert("Logout thành công!");
                        localStorage.removeItem("authToken");
                        window.location.href = "http://127.0.0.1:5500/src/main/resources/templates/HTML/home.html";
                    } else {
                        alert("Lỗi khi logout");
                    }
                });
            } catch (error) {
                console.error('Error during logout:', error);
            }
        }
    
        // Initialize
        showDashboard();
        loadProducts();
    </script>
</body>
</html>