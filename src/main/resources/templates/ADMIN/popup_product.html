
<!-- Popup chỉnh sửa sản phẩm -->
<div id="editProductModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeEditModal()">&times;</span>
    <h2>Chỉnh sửa sản phẩm</h2>
    
    <form id="productForm" onsubmit="handleProductSubmit(event)">
      <div class="form-section">
        <div class="form-group">
          <label>Tên sản phẩm *</label>
          <input type="text" id="editProductName" required>
        </div>

        <div class="form-group">
          <label>Thương hiệu</label>
          <input type="text" id="editBrand">
        </div>

        <div class="form-group">
          <label>Danh mục *</label>
          <select id="editCategory">
            <option value="">Chọn danh mục</option>
          </select>
        </div>

        <div class="form-group">
          <label>Giá bán (VND) *</label>
          <input type="number" id="editPrice" required>
        </div>

        <div class="form-group">
          <label>Mô tả sản phẩm</label>
          <textarea id="editDescription" rows="4"></textarea>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" onclick="closeEditModal()">Hủy</button>
        <button type="submit" class="btn-save">Lưu thay đổi</button>
      </div>
    </form>
  </div>
</div>

<style>
/* CSS */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  animation: fadeIn 0.3s;
}

.modal-content {
  background-color: #fff;
  margin: 2% auto;
  padding: 25px;
  width: 90%;
  max-width: 600px;
  border-radius: 8px;
  position: relative;
}

.close-modal {
  position: absolute;
  right: 20px;
  top: 15px;
  font-size: 28px;
  cursor: pointer;
  color: #666;
  transition: color 0.3s;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.btn-save {
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-cancel {
  background-color: #f44336;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>

<script>
// JavaScript
let currentProductId = null;

async function openEditProductModal(productId) {
  currentProductId = productId;
  const modal = document.getElementById('editProductModal');
  
  try {
    // Hiển thị loading
    modal.style.display = 'block';
    
    // Lấy dữ liệu sản phẩm và danh mục
    const [product, categories] = await Promise.all([
      fetchProduct(productId),
      fetchCategories()
    ]);

    // Điền dữ liệu vào form
    document.getElementById('editProductName').value = product.name;
    document.getElementById('editBrand').value = product.brand;
    document.getElementById('editPrice').value = product.price;
    document.getElementById('editDescription').value = product.description;

    // Điền danh mục
    const categorySelect = document.getElementById('editCategory');
    categorySelect.innerHTML = '<option value="">Chọn danh mục</option>';
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      option.selected = category.id === product.categoryId;
      categorySelect.appendChild(option);
    });

  } catch (error) {
    alert(`Lỗi tải dữ liệu: ${error.message}`);
    closeEditModal();
  }
}

function closeEditModal() {
  document.getElementById('editProductModal').style.display = 'none';
  currentProductId = null;
}

async function handleProductSubmit(event) {
  event.preventDefault();
  
  const productData = {
    name: document.getElementById('editProductName').value.trim(),
    brand: document.getElementById('editBrand').value.trim(),
    categoryId: document.getElementById('editCategory').value,
    price: parseFloat(document.getElementById('editPrice').value),
    description: document.getElementById('editDescription').value.trim()
  };

  // Validate
  if (!productData.name || !productData.categoryId || isNaN(productData.price)) {
    return alert('Vui lòng điền đầy đủ thông tin bắt buộc');
  }

  try {
    const response = await fetch(`/api/products/${currentProductId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
      },
      body: JSON.stringify(productData)
    });

    if (!response.ok) throw new Error('Cập nhật thất bại');
    
    alert('Cập nhật thành công!');
    closeEditModal();
    // Cập nhật lại danh sách
    if (typeof reloadProductList === 'function') reloadProductList();
    
  } catch (error) {
    alert(`Lỗi: ${error.message}`);
  }
}

// Hàm hỗ trợ
async function fetchProduct(productId) {
  const response = await fetch(`/api/products/${productId}`, {
    headers: { Authorization: `Bearer ${localStorage.getItem('authToken')}` }
  });
  if (!response.ok) throw new Error('Không tải được sản phẩm');
  return response.json();
}

async function fetchCategories() {
  const response = await fetch('/api/categories');
  if (!response.ok) throw new Error('Không tải được danh mục');
  return response.json();
}

// Đóng popup khi click bên ngoài
window.onclick = function(event) {
  const modal = document.getElementById('editProductModal');
  if (event.target === modal) closeEditModal();
}
</script>